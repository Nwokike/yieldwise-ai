<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base - YieldWise AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <style>
        .kb-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .kb-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .kb-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .kb-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .kb-card h3 {
            color: #2c6b4f;
            margin-bottom: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            max-width: 800px;
            margin: 40px auto;
            padding: 40px;
            border-radius: 12px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
        }
        
        .ai-chat-box {
            background: #f4f7f6;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üå± YieldWise AI</h2>
            </div>
            <a href="{{ url_for('dashboard') }}" class="tool-link">üìù AI Farm Planner</a>
            <a href="{{ url_for('diagnostician') }}" class="tool-link">üî¨ AI Diagnostician</a>
            <a href="{{ url_for('analytics') }}" class="tool-link">üìä Analytics Dashboard</a>
            <a href="{{ url_for('resources') }}" class="tool-link">üßÆ Resource Calculator</a>
            <a href="{{ url_for('knowledge_base') }}" class="tool-link active">üìö Knowledge Base</a>
            <a href="{{ url_for('community_showcase') }}" class="tool-link">üåç Community Gallery</a>
            <div class="sidebar-footer">
                <a href="{{ url_for('logout') }}" class="logout-button">Log Out</a>
            </div>
        </aside>
        <main class="main-content">
            <div class="container">
                <h1>üìö Farming Knowledge Base</h1>
                <p>AI-powered insights, tips, and best practices for successful farming</p>
                
                <div class="ai-chat-box">
                    <h3>üí¨ Ask AI Expert</h3>
                    <form id="ai-question-form">
                        <input type="text" id="ai-question" placeholder="Ask any farming question..." style="width:100%;padding:12px;margin:10px 0;border:1px solid #ddd;border-radius:8px;">
                        <button type="submit" class="button">Get AI Answer</button>
                    </form>
                    <div id="ai-answer" class="hidden" style="margin-top:20px;padding:15px;background:white;border-radius:8px;"></div>
                </div>
                
                <h2 style="margin:30px 0 20px;">Browse Topics</h2>
                <div class="kb-grid">
                    <div class="kb-card" onclick="showTopic('pest')">
                        <div class="kb-icon">üêõ</div>
                        <h3>Pest Management</h3>
                        <p>Natural and effective pest control methods</p>
                    </div>
                    
                    <div class="kb-card" onclick="showTopic('soil')">
                        <div class="kb-icon">üå±</div>
                        <h3>Soil Health</h3>
                        <p>Improve soil quality and fertility</p>
                    </div>
                    
                    <div class="kb-card" onclick="showTopic('water')">
                        <div class="kb-icon">üíß</div>
                        <h3>Water Management</h3>
                        <p>Efficient irrigation techniques</p>
                    </div>
                    
                    <div class="kb-card" onclick="showTopic('rotation')">
                        <div class="kb-icon">üîÑ</div>
                        <h3>Crop Rotation</h3>
                        <p>Maximize yield with smart rotation</p>
                    </div>
                    
                    <div class="kb-card" onclick="showTopic('organic')">
                        <div class="kb-icon">üåø</div>
                        <h3>Organic Farming</h3>
                        <p>Chemical-free farming practices</p>
                    </div>
                    
                    <div class="kb-card" onclick="showTopic('market')">
                        <div class="kb-icon">üè™</div>
                        <h3>Marketing Tips</h3>
                        <p>Sell your produce effectively</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="topic-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="topic-content"></div>
        </div>
    </div>

    <script>
        const topics = {
            pest: {
                title: 'üêõ Pest Management Guide',
                content: `
                    <h2>Integrated Pest Management</h2>
                    <h3>1. Prevention First</h3>
                    <ul>
                        <li>Plant pest-resistant varieties</li>
                        <li>Maintain healthy soil</li>
                        <li>Practice crop rotation</li>
                        <li>Keep the farm clean</li>
                    </ul>
                    <h3>2. Natural Controls</h3>
                    <ul>
                        <li><strong>Neem Oil:</strong> Effective against aphids, whiteflies</li>
                        <li><strong>Garlic Spray:</strong> Repels many insects</li>
                        <li><strong>Companion Planting:</strong> Marigolds deter pests</li>
                        <li><strong>Beneficial Insects:</strong> Ladybugs eat aphids</li>
                    </ul>
                    <h3>3. Monitoring</h3>
                    <p>Check plants daily for early signs of infestation</p>
                `
            },
            soil: {
                title: 'üå± Soil Health Guide',
                content: `
                    <h2>Building Healthy Soil</h2>
                    <h3>1. Organic Matter</h3>
                    <p>Add compost regularly to improve soil structure and nutrients</p>
                    <h3>2. pH Management</h3>
                    <ul>
                        <li>Most crops prefer pH 6.0-7.0</li>
                        <li>Add lime to raise pH (acidic soil)</li>
                        <li>Add sulfur to lower pH (alkaline soil)</li>
                    </ul>
                    <h3>3. Mulching</h3>
                    <p>Use organic mulch to retain moisture and suppress weeds</p>
                    <h3>4. Avoid Compaction</h3>
                    <p>Don't work wet soil; use raised beds if needed</p>
                `
            },
            water: {
                title: 'üíß Water Management Tips',
                content: `
                    <h2>Efficient Irrigation</h2>
                    <h3>1. Drip Irrigation</h3>
                    <p>Most efficient - delivers water directly to roots, saves up to 50% water</p>
                    <h3>2. Timing Matters</h3>
                    <ul>
                        <li>Water early morning or evening</li>
                        <li>Avoid midday watering (high evaporation)</li>
                        <li>Water deeply, less frequently</li>
                    </ul>
                    <h3>3. Rainwater Harvesting</h3>
                    <p>Collect rainwater in barrels/tanks for dry seasons</p>
                    <h3>4. Moisture Monitoring</h3>
                    <p>Finger test: soil should be moist 2 inches deep</p>
                `
            },
            rotation: {
                title: 'üîÑ Crop Rotation Benefits',
                content: `
                    <h2>Smart Crop Rotation</h2>
                    <h3>Why Rotate?</h3>
                    <ul>
                        <li>Prevents pest and disease buildup</li>
                        <li>Improves soil fertility</li>
                        <li>Reduces weed pressure</li>
                        <li>Increases yields</li>
                    </ul>
                    <h3>Simple 3-Year Rotation</h3>
                    <p><strong>Year 1:</strong> Leafy vegetables (Spinach, Lettuce)</p>
                    <p><strong>Year 2:</strong> Legumes (Beans, Peas) - add nitrogen</p>
                    <p><strong>Year 3:</strong> Root/Fruit vegetables (Tomatoes, Carrots)</p>
                    <h3>Golden Rule</h3>
                    <p>Never plant the same family in the same spot two years in a row</p>
                `
            },
            organic: {
                title: 'üåø Organic Farming Basics',
                content: `
                    <h2>Going Organic</h2>
                    <h3>1. No Synthetic Chemicals</h3>
                    <p>Use natural fertilizers and pest controls only</p>
                    <h3>2. Build Soil Naturally</h3>
                    <ul>
                        <li>Compost from kitchen waste</li>
                        <li>Green manure crops</li>
                        <li>Animal manure (well-composted)</li>
                    </ul>
                    <h3>3. Natural Pest Control</h3>
                    <ul>
                        <li>Companion planting</li>
                        <li>Beneficial insects</li>
                        <li>Organic sprays (neem, garlic)</li>
                    </ul>
                    <h3>4. Benefits</h3>
                    <p>Healthier produce, better prices, sustainable farming</p>
                `
            },
            market: {
                title: 'üè™ Marketing Your Produce',
                content: `
                    <h2>Selling Successfully</h2>
                    <h3>1. Know Your Market</h3>
                    <ul>
                        <li>Local markets and fairs</li>
                        <li>Restaurants and hotels</li>
                        <li>Direct to consumers</li>
                        <li>Online platforms</li>
                    </ul>
                    <h3>2. Quality First</h3>
                    <p>Clean, fresh produce sells better and commands higher prices</p>
                    <h3>3. Packaging Matters</h3>
                    <p>Present your produce attractively</p>
                    <h3>4. Build Relationships</h3>
                    <p>Regular customers are your best asset - be reliable and consistent</p>
                    <h3>5. Pricing Strategy</h3>
                    <p>Research local prices, consider your costs, but stay competitive</p>
                `
            }
        };

        function showTopic(topicId) {
            const topic = topics[topicId];
            document.getElementById('topic-content').innerHTML = `
                <div class="kb-icon" style="text-align:center">${topic.title.split(' ')[0]}</div>
                ${topic.content}
            `;
            document.getElementById('topic-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('topic-modal').style.display = 'none';
        }

        document.getElementById('ai-question-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = document.getElementById('ai-question').value;
            if (!question.trim()) return;
            
            const answerDiv = document.getElementById('ai-answer');
            answerDiv.innerHTML = '<p style="color:#666;">Getting AI answer...</p>';
            answerDiv.classList.remove('hidden');
            
            try {
                const response = await fetch('/api/knowledge_query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                
                if (!response.ok) throw new Error('Failed to get answer');
                
                const data = await response.json();
                answerDiv.innerHTML = data.answer;
                NotificationManager.success('Answer received!');
            } catch (error) {
                answerDiv.innerHTML = '<p class="error-message">Could not get answer. Please try again.</p>';
                NotificationManager.error('Failed to get AI answer');
            }
        });
    </script>
</body>
</html>
