{% extends "base.html" %}

{% block title %}AI Plant Doctor - YieldWise AI{% endblock %}

{% block content %}
<div class="bg-primary text-white py-4">
    <div class="container">
        <h1 class="fw-bold mb-2">
            <i class="bi bi-camera"></i> AI Plant Doctor
        </h1>
        <p class="mb-0">Upload a plant photo for instant disease diagnosis</p>
    </div>
</div>

<div class="container py-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h4 class="mb-0 fw-bold"><i class="bi bi-camera-fill text-primary"></i> Upload Plant Image</h4>
        </div>
        <div class="card-body">
            <form id="diagnosis-form" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Plant Image</label>
                    <input type="file" class="form-control form-control-lg" id="plant_image" name="plant_image" accept="image/*" required>
                    <small class="text-muted">Supported formats: JPG, PNG (Max 5MB)</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">Crop Type</label>
                    <input type="text" class="form-control form-control-lg" id="crop_type" name="crop_type" placeholder="e.g., Cassava, Maize, Tomato, Yam, Rice, Plantain" required>
                    <small class="form-text text-muted">Nigerian farmers: Specify your exact crop for best diagnosis</small>
                </div>
                
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="bi bi-search"></i> Diagnose Plant
                </button>
            </form>
        </div>
    </div>

    <div id="diagnosis-result" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0 fw-bold"><i class="bi bi-check-circle"></i> Diagnosis Report</h4>
        </div>
        <div class="card-body">
            <h5 id="diagnosis-title" class="fw-bold text-primary mb-3"></h5>
            <div id="diagnosis-content"></div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h4 class="mb-0 fw-bold"><i class="bi bi-clock-history text-primary"></i> Your Diagnoses</h4>
        </div>
        <div class="card-body">
            {% if diagnoses %}
            <div class="row g-3">
                {% for diagnosis in diagnoses %}
                <div class="col-md-6">
                    <div class="card diagnosis-card h-100">
                        <div class="card-body">
                            <h5 class="fw-bold text-primary">
                                <i class="bi bi-capsule"></i> {{ diagnosis.title }}
                            </h5>
                            <p class="text-muted mb-2">
                                <small>
                                    <i class="bi bi-calendar"></i> {{ diagnosis.created_at|dateformat }}
                                </small>
                            </p>
                            <p class="text-muted mb-3">
                                <strong>Crop:</strong> {{ diagnosis.crop_type }}
                            </p>
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-sm btn-primary view-diagnosis" data-diagnosis-id="{{ diagnosis.id }}">
                                    <i class="bi bi-eye"></i> View Report
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-diagnosis" data-diagnosis-id="{{ diagnosis.id }}">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>No diagnoses yet. Upload a plant image above to get started!</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('diagnosis-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('plant_image', document.getElementById('plant_image').files[0]);
    formData.append('crop_type', document.getElementById('crop_type').value);
    
    try {
        showLoading();
        const response = await fetch('/api/diagnose', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        hideLoading();
        
        if (!response.ok) {
            throw new Error(result.error || 'An error occurred');
        }
        
        document.getElementById('diagnosis-title').textContent = result.title;
        document.getElementById('diagnosis-content').innerHTML = result.diagnosis;
        document.getElementById('diagnosis-result').style.display = 'block';
        document.getElementById('diagnosis-result').scrollIntoView({ behavior: 'smooth' });
        
        showNotification('Diagnosis completed successfully!', 'success');
        
        setTimeout(() => location.reload(), 2000);
    } catch (error) {
        hideLoading();
        showNotification(error.message, 'danger');
    }
});

document.querySelectorAll('.view-diagnosis').forEach(btn => {
    btn.addEventListener('click', async function() {
        const diagnosisId = this.dataset.diagnosisId;
        try {
            const result = await fetchJSON('/api/get_diagnosis/' + diagnosisId);
            document.getElementById('diagnosis-title').textContent = result.diagnosis.title;
            document.getElementById('diagnosis-content').innerHTML = result.diagnosis.report_html;
            document.getElementById('diagnosis-result').style.display = 'block';
            document.getElementById('diagnosis-result').scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            console.error(error);
        }
    });
});

document.querySelectorAll('.delete-diagnosis').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (!confirm('Are you sure you want to delete this diagnosis?')) return;
        
        const diagnosisId = this.dataset.diagnosisId;
        try {
            await fetchJSON('/api/delete_diagnosis/' + diagnosisId, { method: 'DELETE' });
            showNotification('Diagnosis deleted successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            console.error(error);
        }
    });
});
</script>
{% endblock %}
